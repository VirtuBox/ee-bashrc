#!/bin/bash
#----------------------------------------------------------------------------
# wo-bashrc -  bashrc functions and alias
#----------------------------------------------------------------------------
# Website:       https://virtubox.net
# GitHub:        https://github.com/VirtuBox/ee-acme-sh
# Copyright (c) 2018 VirtuBox <contact@virtubox.net>
# This script is licensed under M.I.T
#---------------------------------------------------------------------------
# Version 0.1 - 2019-19-01
# --------------------------------------------------------------------------

[ ! -d $HOME/.wo-scripts ] && {
    mkdir -p $HOME/.wo-scripts
}

##################################
# functions
##################################

# Nginx-ee compilation

_NGINX_EE() {
    wget -O $HOME/.wo-scripts/nginx-build.sh https://raw.githubusercontent.com/VirtuBox/nginx-ee/master/nginx-build.sh
    chmod +x $HOME/.wo-scripts/nginx-build.sh
    $HOME/.wo-scripts/nginx-build.sh --mainline
}

_MAINTENANCE() {

    # Colors
    CSI='\033['
    CEND="${CSI}0m"
    CRED="${CSI}1;31m"
    CGREEN="${CSI}1;32m"

    echo -e "${CGREEN}#############################################${CEND}"
    echo -e '       APT UPDATE               '
    echo -e "${CGREEN}#############################################${CEND}"
    sudo apt update
    echo -e "${CGREEN}#############################################${CEND}"
    echo -e '       APT FULL-UPGRADE               '
    echo -e "${CGREEN}#############################################${CEND}"
    sudo apt full-upgrade -y
    echo -e "${CGREEN}#############################################${CEND}"
    echo -e '       APT-GET AUTOREMOVE              '
    echo -e "${CGREEN}#############################################${CEND}"
    sudo apt-get -y --purge autoremove
    echo -e "${CGREEN}#############################################${CEND}"
    echo -e '       APT AUTOCLEAN               '
    echo -e "${CGREEN}#############################################${CEND}"
    sudo apt-get -y autoclean
    sudo apt-get -y clean
    ## clean packages in deinstall state
    DEINSTALLED=$(sudo dpkg --get-selections | grep deinstall | cut -f1)
    if [ ! -z "$DEINSTALLED" ]; then
        echo -e "${CGREEN}#############################################${CEND}"
        echo -e '       CLEAN DEINSTALL PACKAGES               '
        echo -e "${CGREEN}#############################################${CEND}"
        sudo dpkg --get-selections | grep deinstall | cut -f1 | xargs dpkg --purge
    fi
    if [ -x /usr/bin/docker ]; then
        echo -e "${CGREEN}#############################################${CEND}"
        echo -e '       DOCKER CLEANUP               '
        echo -e "${CGREEN}#############################################${CEND}"
        list_images=$(docker images --filter "dangling=true" -q --no-trunc)
        list_volumes=$(docker volume ls -qf dangling=true)
        if [ ! -z "$list_images" ]; then
            docker rmi "$list_images"
        fi
        if [ ! -z "$list_volumes" ]; then
            docker volume rm "$list_volumes"
        fi
    fi
    OLD_LOGS=$(sudo find /var/log/ -type f -mtime +30 -iname "*.gz")
    if [ ! -z "$OLD_LOGS" ]; then
        echo -e "${CGREEN}#############################################${CEND}"
        echo -e '       CLEANUP OLD LOGS               '
        echo -e "${CGREEN}#############################################${CEND}"
        sudo find /var/log/ -type f -mtime +30 -iname "*.gz" -exec rm '{}' \;
    fi
    echo -e "${CGREEN}#############################################${CEND}"
    echo -e '       WO-BASHRC UPDATE               '
    echo -e "${CGREEN}#############################################${CEND}"
    update_git_mybashrc

}

_syslog() {
    if [ "$(id -u)" != "0" ]; then
        tail -n 250 /var/log/syslog | ccze -A
    else
        sudo tail -n 250 /var/log/syslog | ccze -A
    fi
}

_docker() {
    curl -fsSL get.docker.com -o $HOME/.wo-scripts/get-docker.sh
    chmod +x $HOME/.wo-scripts/get-docker.sh
    $HOME/.wo-scripts/get-docker.sh
}

_mysqltuner() {
    if [ ! -d $HOME/.wo-scripts ]; then
        mkdir -p $HOME/.wo-scripts
    fi
    wget -O $HOME/.wo-scripts/mysqltuner.pl https://raw.githubusercontent.com/major/MySQLTuner-perl/master/mysqltuner.pl
    chmod +x $HOME/.wo-scripts/mysqltuner.pl
    $HOME/.wo-scripts/mysqltuner.pl
}

_mysqlcheck() {
    if [ -d /etc/psa ]; then
        MYSQL_PWD=$(cat /etc/psa/.psa.shadow) mysqlcheck -Aos -uadmin --auto-repair
    else
        mysqlcheck -Aos --auto-repair
    fi
}

_cronjob() {
    if [ "$(id -u)" != "0" ]; then
        cat /var/spool/cron/crontabs/*
    else
        sudo cat /var/spool/cron/crontabs/*
    fi
}

_password() {

    pass=$(date +%s | sha256sum | base64 | head -c 32)
    echo ""
    echo "Password : $pass"
    echo ""
}

_speedtest() {
    wget -O $HOME/.wo-scripts/speedtest-cli https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py
    chmod +x $HOME/.wo-scripts/speedtest-cli
    $HOME/.wo-scripts/speedtest-cli --share
}

_sysinfo() {
    # Reading out system information...
    # Reading CPU model
    cname=$(awk -F: '/model name/ {name=$2} END {print name}' /proc/cpuinfo | sed 's/^[ \t]*//;s/[ \t]*$//')
    # Reading amount of CPU cores
    cores=$(awk -F: '/model name/ {core++} END {print core}' /proc/cpuinfo)
    # Reading CPU frequency in MHz
    freq=$(awk -F: ' /cpu MHz/ {freq=$2} END {print freq}' /proc/cpuinfo | sed 's/^[ \t]*//;s/[ \t]*$//')
    # Reading total memory in MB
    tram=$(free -m | awk 'NR==2 {print $2}')
    # Reading Swap in MB
    vram=$(free -m | awk 'NR==4 {print $2}')
    # Reading system uptime
    up=$(uptime | awk '{ $1=$2=$(NF-6)=$(NF-5)=$(NF-4)=$(NF-3)=$(NF-2)=$(NF-1)=$NF=""; print }' | sed 's/^[ \t]*//;s/[ \t]*$//')
    # Reading operating system and version (simple, didn't filter the strings at the end...)
    opsy=$(cat /etc/issue.net | awk 'NR==1 {print}') # Operating System & Version
    arch=$(uname -m)                                 # Architecture
    lbit=$(getconf LONG_BIT)                         # Architecture in Bit
    hn=$(hostname -f)                                # Hostname
    kern=$(uname -r)
    echo ""
    # Output of results
    echo "System Info"
    echo "Server : $hn"
    echo "-----------"
    echo "Processor	: $cname"
    echo "CPU Cores	: $cores"
    echo "Frequency	: $freq MHz"
    echo "Memory		: $tram MB"
    echo "Swap		: $vram MB"
    echo "Uptime		: $up"
    echo "-----------"
    echo "OS		: $opsy"
    echo "Arch		: $arch ($lbit Bit)"
    echo "Kernel		: $kern"
    echo ""
}

_foldersize() {
    du -sh ./* | sort -h
}

_transfer_sh() {
    { /usr/bin/curl --progress-bar --upload-file "$1" https://transfer.sh/"$(basename "$1")" && echo ""; } | tee -a $HOME/.transfer.log && echo ""
}

_compress_pigz() {
    /bin/tar -I pigz -cvf "$1".tar.gz "$1"
}

_decompress_pigz() {
     /bin/tar -I pigz -xvf "$1"
}

_wo_showlog() {

    tail -n 500 "$1" | ccze -A

}

_help() {
    echo "Command-Line tool for Debian/Ubuntu Servers"
    echo "Usage: wo-bashrc <option>"
    echo "  Commands:"
    echo "       --nginx-ee ... compile the latest nginx mainline release with nginx-ee bash script"
    echo "       --maintenance ... run apt-get update, apt-get upgrade, apt-get autoclean etc.."
    echo "       --syslog ... show the last 250 lines of syslog"
    echo "       --showlog <file.log> ... display logs with color using ccze"
    echo "       --netdata ... setup netdata monitoring suite"
    echo "       --docker ... setup docker"
    echo "       --mysqltuner ... download and run mysqltuner script"
    echo "       --mysqlcheck ... run mysqlcheck to repair and optimize all MySQL databases"
    echo "       --cronjob ... list all cronjobs"
    echo "       --password ... generate a password"
    echo "       --speedtest ... run a speedtest using speedtest-cli"
    echo "       --sysinfo ... display various informations about the server"
    echo "       --foldersize ... find the biggest folder in a directory"
    echo "       --gpigz <file/folder name> ... compress a file or a folder with tar and multithreaded gzip"
    echo "       --gunpigz <archive> ... decompress a tar.gz archive with pigz"
    echo "       --transfer <file> ... transfer a file from the command line with transfer.sh"
    echo "       --wobashrc-update ... update wo-bashrc"
    echo "       -h, --help, help ... displays this help information"
    echo ""
    return 0
}

if [ "${#}" = "0" ]; then
    _help
    exit 1
else
    while [ ${#} -gt 0 ]; do
        case "${1}" in
        "--nginx-ee")
            _NGINX_EE
            exit 1
            ;;
        "--maintenance")
            _MAINTENANCE
            exit 1
            ;;
        "--syslog")
            _syslog
            exit 1
            ;;
        "--showlog")
            _wo_showlog "$2"
            exit 1
            shift
            ;;
        "--netdata")
            _netdata
            exit 1
            ;;
        "--docker")
            _docker
            exit 1
            ;;
        "--mysqltuner")
            _mysqltuner
            exit 1
            ;;
        "--mysqlcheck")
            _mysqlcheck
            exit 1
            ;;
        "--cronjob")
            _cronjob
            exit 1
            ;;
        "--password")
            _password
            exit 1
            ;;
        "--speedtest")
            _speedtest
            exit 1
            ;;
        "--sysinfo")
            _sysinfo
            exit 1
            ;;
        "--foldersize")
            _foldersize
            exit 1
            ;;
        "--transfer")
            _transfer_sh "$2"
            exit 1
            shift
            ;;

        "-h" | "--help" | "help")
            _help
            exit 1
            ;;
        *) ;;
        esac
        shift
    done
fi
